<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Issue Log Fixer → TSV for Feishu</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0c10; color:#eaeaf0; }
    header { padding: 16px 18px; border-bottom: 1px solid #1f2230; background:#0d0f16; position: sticky; top:0; }
    h1 { font-size: 16px; margin: 0 0 6px 0; }
    p { margin: 0; opacity: .8; font-size: 13px; line-height: 1.35; }
    main { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
    .card { border: 1px solid #1f2230; border-radius: 12px; overflow:hidden; background:#0d0f16; }
    .card h2 { font-size: 13px; margin: 0; padding: 10px 12px; border-bottom: 1px solid #1f2230; opacity:.9; }
    .card .body { padding: 12px; }
    textarea { width: 100%; min-height: 280px; background:#0b0c10; color:#eaeaf0; border:1px solid #262a3b; border-radius: 10px; padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size: 12px; line-height: 1.35; }
    input, select { background:#0b0c10; color:#eaeaf0; border:1px solid #262a3b; border-radius: 10px; padding: 8px 10px; font-size: 13px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1; min-width: 160px; }
    .btns { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { cursor:pointer; border:1px solid #2a2f44; background:#121525; color:#eaeaf0; border-radius: 10px; padding: 8px 10px; font-size: 13px; }
    button.primary { background:#1a2455; border-color:#2e3aa0; }
    button.good { background:#0f2a1c; border-color:#1f6b44; }
    .small { font-size: 12px; opacity:.75; margin-top: 8px; line-height: 1.35; }
    .warn { color:#ffd37a; }
    code { background:#0b0c10; border:1px solid #262a3b; padding: 2px 6px; border-radius: 8px; }
    @media (max-width: 980px){ main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header>
  <h1>Issue Log Fixer → TSV (Feishu-friendly)</h1>
  <p>Paste raw logs → Generate TSV → paste into Feishu. Keeps Device Type → Quality(empty) → Device No.</p>
</header>

<main>
  <section class="card">
    <h2>1) Raw input</h2>
    <div class="body">
      <div class="row" style="margin-bottom:10px;">
        <label>
          <div class="small">Date (YYYY/MM/DD)</div>
          <input id="date" value="2026/02/26" />
        </label>
        <label>
          <div class="small">Default Device Type</div>
          <input id="deviceType" value="K50H" />
        </label>
        <label>
          <div class="small">Default Status</div>
          <input id="status" value="已处理Processed" />
        </label>
        <label>
          <div class="small">Default Temporary measures</div>
          <input id="tempMeasures" value="recovery" />
        </label>
      </div>

      <textarea id="raw" placeholder="Paste raw log here..."></textarea>

      <div class="btns">
        <button class="primary" id="gen" type="button">Generate TSV</button>
        <button id="clear" type="button">Clear</button>
        <button id="loadExample" type="button">Load example</button>
      </div>

      <div class="small warn">
        If you put this HTML into Feishu/Wiki/Docs, scripts are blocked and buttons won’t work.
        You must open it as a local file: <code>file:///...</code>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>2) Output (TSV)</h2>
    <div class="body">
      <div class="row" style="margin-bottom:10px;">
        <label>
          <div class="small">Default minutes if unknown</div>
          <input id="defaultMin" value="2" />
        </label>
      </div>

      <textarea id="out" placeholder="TSV will appear here..."></textarea>

      <div class="btns">
        <button class="good" id="copy" type="button">Copy TSV</button>
        <button id="download" type="button">Download .tsv</button>
      </div>

      <div class="small">Abnormal time format: <code>00:06</code>. End time = Start + minutes.</div>
    </div>
  </section>
</main>

<script>
(function(){
  "use strict";

  const $ = (id) => document.getElementById(id);

  // ---------------------------
  // Allowed dropdown values (MUST MATCH EXACTLY)
  // ---------------------------
  const ISSUE_TYPE = {
    Construction: "施工Construction",
    Equipment: "设备Equipment",
    System: "系统System",
    Environment: "环境Environment",
    Customer: "客户Customer",
    Interface: "接口Interface",
    Operation: "操作Operation",
    Network: "网络Network",
    Unknown: "未知Unknown",
    Design: "设计Design"
  };

  const QUICK = {
    AbnormalPick: "取放货异常Abnormal pick-up and delivery",
    ObstacleAvoid: "避障Obstacle avoidance",
    ForkNoContainer: "货叉检测无容器Forklift detection without container",
    DMCodeError: "识别不到地面码DM Code Error",
    StructuralDamage: "结构件损坏Structural damage",
    UnableDrive: "行走异常Unable to drive",
    NetAbn: "网络通讯异常Network communication abnormality",
    DropBox: "掉箱子或掉落件Drop Box or items",
    BoxStuck: "卡箱异常Box stuck",
    CollisionShelf: "撞货架Collision with Shelf",
    AbnCharging: "充电异常Abnormal charging",
    AbnSound: "设备异响Equipment abnormal sound",
    DataError: "数据错误data error",
    ConveyorScanAbn: "输送线读码器扫码异常",
    RobotSafetyTriggered: "机器人安全装置触发Robot safety device triggered",
    SafetyDoorTriggered: "安全门装置触发Safety door device activated",
    TwoRobotsCollide: "机器人相互碰撞 Two robots collide",
    PersonDetectFail: "人员检测模块故障Personel detection module failure",
    SpeedError: "速度错误Speed Error",
    MotorPwr: "Motor or Powerstage llt error",
    SafetySelfCheck: "安全自检失败safety self check failure",
    NoObjectDetected: "料箱检测无容器No object detected",
    PowerModuleAbn: "电源模块异常Power module is abnormal"
  };

  // Problem location / Issue sub type (问题定位) – must match exactly
  const SUB = {
    GroundDirty: "地面码脏污 Ground code dirty",
    MissingDM: "地面码缺失 Ground code missing",
    Uneven: "地面不平 Uneven ground",
    GroundSeam: "地缝影响 Ground seam effect",
    ForeignObjects: "地面异物Foreign objects on the ground", // IMPORTANT no space
    CannotLocate: "无法定义异常 Problem Cannot located",
    ProgramBug: "程序逻辑BUG Program logic bug",
    LiftingHeight: "举升高度误差Lifting height error",
    WrongPickPlace: "取放箱位置错误 Wrong pick and place box position",
    IrregularOp: "操作不规范 Irregular operation",
    IrregularOperation: "操作不规范 Irregular operation",
    EmergencyStopDamaged: "急停按钮损坏 Emergency stop button is damaged",
    SecurityModuleFail: "安全模块故障Security module failure",
    ParameterConfigErr: "参数配置错误 Parameter configuration error",
    DriverComponentEx: "驱动组件异常 Driver component exception",
    ObstacleOnPath: "路径上有障碍物 Obstacle on the path",
    MainCtrlComm: "主控板通讯异常Main control board communication anomaly",
    AbnormalLifting: "举升机构异常 Abnormal lifting mechanism",
    LostBoxPos: "取放箱位置错误 Wrong pick and place box position",
    CannotLocated: "无法定义异常 Problem Cannot located",
    LiftingHeight: "举升高度误差Lifting height error",
    MaterialSuperHigh: "物料超高 Material super high",
    SecurityModule: "安全模块故障Security module failure",
    ProgramBug: "程序逻辑BUG Program logic bug",
    ChassisCam: "底盘相机故障 Chassis camera malfunction"
  };

  // ---------------------------
  // Helpers
  // ---------------------------
  function pad2(n){ return String(n).padStart(2,"0"); }
  function parseTimeToMinutes(t){
    const m = String(t).trim().match(/^(\d{1,2})\s*:\s*(\d{2})$/);
    if(!m) return null;
    const hh = +m[1], mm = +m[2];
    if(hh>23 || mm>59) return null;
    return hh*60 + mm;
  }
  function minutesToHHMM(total){
    total = ((total % 1440) + 1440) % 1440;
    return `${Math.floor(total/60)}:${pad2(total%60)}`;
  }
  function abnormalFmt(mins){ return `00:${pad2(Math.max(0, Math.round(mins)))}`; }

  function normText(s){
    return String(s)
      .replace(/\s+/g," ")
      .replace(/[，]/g,",")
      .trim();
  }
  function low(s){ return normText(s).toLowerCase(); }

  function extractTime(line){
    const m = line.match(/(\d{1,2}\s*:\s*\d{2})(?!.*\d{1,2}\s*:\s*\d{2})/);
    return m ? m[1].replace(/\s+/g,"") : "";
  }

  // Extract one or many device numbers:
  //  "209,2145. ..." => ["209","2145"]
  //  "764/H136. ..." => ["764/H136"]
  //  "CS105,2099 . ..." => ["CS105","2099"]
  function extractDeviceNos(line){
    const head = line.trim().match(/^([A-Za-z]{0,3}\d+(?:\/[A-Za-z]?\d+)?(?:\s*,\s*[A-Za-z]{0,3}\d+(?:\/[A-Za-z]?\d+)?)*)\s*\./);
    if(!head) return [""];
    return head[1].split(",").map(x => x.trim()).filter(Boolean);
  }

  // Split input into records with names
  function splitIntoRecords(raw){
    const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    let name = "";
    const recs = [];
    for(const line of lines){
      const isName = !/[0-9]/.test(line) && !/\./.test(line) && line.length <= 60;
      if(isName){ name = line; continue; }
      recs.push({name, line});
    }
    return recs;
  }

  // ---------------------------
  // RULE ENGINE (STRICT OPTIONS ONLY)
  // ---------------------------
  function classify(line){
    // user rule: no "Unable to rotate" option -> treat as Unable to drive
    let txt = normText(line)
      .replace(/unable to rotate/ig, "Unable to drive")
      .replace(/dirty dm code/ig, "Dirty DM code")
      .replace(/lost dm code/ig, "Missing DM code"); // treat as missing dm for dropdown consistency

    const L = low(txt);

    // default for Unable to drive = Equipment (you asked)
    let issueType = ISSUE_TYPE.Equipment;
    let quick = QUICK.UnableDrive;
    let subType = SUB.CannotLocate;
    let issueDesc = txt.replace(/^\s*[^.]+\.\s*/,"").replace(/\s*\d{1,2}:\d{2}\s*$/,"").trim();
    let recovery = "Recovery";
    let minutes = Number($("defaultMin").value) || 2;

    // ---- DM cases ----
    if(L.includes("dirty dm code") || L.includes("ground code dirty")){
      issueType = ISSUE_TYPE.Environment;               // YOU SPECIFIED this
      quick = QUICK.UnableDrive;
      subType = SUB.GroundDirty;
      issueDesc = "Unable to drive. Dirty DM code.";
      recovery = "DM was cleaned, recovery key";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if(L.includes("missing dm code")){
      issueType = ISSUE_TYPE.Equipment;                 // YOU SPECIFIED this
      quick = QUICK.UnableDrive;
      subType = SUB.ChassisCam;                         // you asked chassis cam for missing dm
      issueDesc = "Unable to drive. Missing DM code.";
      recovery = "Recovery key and set to DM code";
      minutes = 3;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // If phrase says "could not find dm code on the floor"
    if(L.includes("could not find dm code") || L.includes("cannot find dm code")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.ChassisCam; // floor code missing
      issueDesc = "Could not find DM code on the floor.";
      recovery = "Recovery";
      minutes = 3;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- uneven / seam ----
    if(L.includes("uneven ground")){
      issueType = ISSUE_TYPE.Environment;                 // you said mostly Equipment
      quick = QUICK.UnableDrive;
      subType = SUB.Uneven;
      issueDesc = "Unable to drive. Uneven ground.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if(L.includes("ground seam")){
      issueType = ISSUE_TYPE.Environment;
      quick = QUICK.UnableDrive;
      subType = SUB.GroundSeam;
      issueDesc = "Unable to drive. Ground seam effect.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("lifting mechanism failure")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.LiftingHeight;
      issueDesc = "Lifting mechanism failure.";
      recovery = "Recovery";
      minutes = 2;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // ---- foreign object on floor ----
    if(L.includes("foreign object on the floor") || L.includes("foreign objects on the floor") || L.includes("foreign object")){
      issueType = ISSUE_TYPE.Customer;
      quick = QUICK.UnableDrive;                        // forced due to your dropdown limitation
      subType = SUB.ForeignObjects;                     // MUST be exact no-space version
      issueDesc = "Unable to drive. Foreign object on the floor.";
      recovery = "DM was cleaned, recovery key";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- obstacle detection in tally station ----
    if(L.includes("obstacle detection in tally station")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.ObstacleAvoid;
      subType = SUB.CannotLocate;
      issueDesc = "Obstacle detection in tally station";
      recovery = "Recovery";
      minutes = 4;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("lost his track in tally station")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.CannotLocated;
      issueDesc = "Lost his track in tally station";
      recovery = "Recovery";
      minutes = 2;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // ---- lost track / no sound ----
    if(L.includes("lost his track") || L.includes("no sound")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.CannotLocate;
      issueDesc = "Lost his track, no sound.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if(L.includes("system error")){
      issueType = ISSUE_TYPE.System;
      quick = QUICK.UnableDrive;
      subType = SUB.ProgramBug;
      issueDesc = "System error, unknown";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- collision of 2 robots ----
    if(L.includes("collision of 2 robots") || L.includes("robots collided") || L.includes("robot collision")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.TwoRobotsCollide;
      subType = SUB.CannotLocate;
      issueDesc = "Collision of 2 robots. Robots collided.";
      recovery = "Change of position and recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("collision of 2 robots") && L.includes("kiva") && L.includes("take a case")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.TwoRobotsCollide;
      subType = SUB.LostBoxPos;
      issueDesc = "Robots collided, while Kiva tired to take a case";
      recovery = "Change of position and recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("collision of 2 robots") && L.includes("kubot") && L.includes("take a case")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.TwoRobotsCollide;
      subType = SUB.LostBoxPos;
      issueDesc = "Robots collided, while Kubot tired to take a case";
      recovery = "Change of position and recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if ((L.includes("failed to take the box") || L.includes("failed to take the case")) && L.includes("hit the workstation")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.CollisionShelf;
      subType = SUB.LostBoxPos;
      issueDesc = "Failed to take the box, hit the workstation";
      recovery = "Change of position and recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // ---- no object after detection picking on lifting tray ----
    if(L.includes("no object after detection")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.NoObjectDetected;
      subType = SUB.LiftingHeight;
      issueDesc = "No object after detection picking on lifting tray (conveyor).";
      recovery = "Case was put on a robot, recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("abnormal box delivery") || (L.includes("failed to place") && L.includes("dropped"))) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.LostBoxPos;
      issueDesc = "Abnormal box delivery. Failed to place a case, dropped case.";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("failed to delivered a case") && L.includes("irregular operation") && L.includes("tally")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.IrregularOperation; // make sure SUB.IrregularOperation exists in your SUB list
      issueDesc = "Failed to delivered a case, irregular operation on tally station.";
      recovery = "Box moved out";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("failed to place a case") && (L.includes("material box too high") || L.includes("too high"))) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.MaterialSuperHigh;
      issueDesc = "Failed to place a case, material box too high";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("external retrieval abnormal")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.AbnormalLifting;
      issueDesc = "External retrieval abnormal.";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // ---- safety vest detection speed monitor failure ----
    if(L.includes("safety vest detection speed") || (L.includes("vest") && L.includes("key"))){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.SpeedError;
      subType = SUB.ProgramBug;
      issueDesc = "Safety vest detection speed monitor failure.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- all protection triggers released / abnormal lifting mechanism ----
    if (L.includes("all protection triggers") || (L.includes("abnormal lifting") && L.includes("mechanism"))){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.RobotSafetyTriggered;
      subType = SUB.AbnormalLifting;   // <-- we must add this key below
      issueDesc = "All protection triggers has been released. Abnormal lifting mechanisms.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- emergency stop ----
    if(L.includes("emergency stop")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.RobotSafetyTriggered;
      subType = SUB.EmergencyStopDamaged;
      issueDesc = "Emergency stop triggered. Emergency stop button damaged.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- safety self check ----
    if(L.includes("safety self check failure")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.SafetySelfCheck;
      subType = SUB.SecurityModuleFail;
      issueDesc = "Safety self check failure. Security module failure.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- charging failure ----
    if(L.includes("charging failure")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnCharging;
      subType = SUB.ParameterConfigErr;
      issueDesc = "Charging failure. Parameter configuration error.";
      recovery = L.includes("dynamic") ? "Changed mode to Dynamic" : "Changed mode to Auto";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- speed error / drive component exception ----
    if(L.includes("speed error") || L.includes("drive component exception")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.SpeedError;
      subType = SUB.DriverComponentEx;
      issueDesc = "Speed error. Drive component exception.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- customer fault example: box already on position ----
    if(L.includes("customer fault") || L.includes("box already on the position") || L.includes("box already on position")){
      issueType = ISSUE_TYPE.Customer;
      quick = QUICK.AbnormalPick;
      subType = SUB.IrregularOp;
      issueDesc = "Failed to take the box. Box already on position. Customer fault.";
      recovery = "Put box back";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("battery communication failure")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.PowerModuleAbn;
      subType = SUB.CannotLocated;
      issueDesc = "Battery communication failure. Unknown reason.";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("fail to take a case") && L.includes("wrong box position")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.LostBoxPos;
      issueDesc = "Wrong box position";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("kiva failed to place a case") && L.includes("tote misaligned")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.BoxStuck;
      subType = SUB.LostBoxPos;
      issueDesc = "Kiva failed to place a case, tote misaligned during transfer, left hanging diagonally in rack";
      recovery = "Recovery";
      minutes = 5;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("personal detection monitor failure") || (L.includes("security module failure") && L.includes("personal"))) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.PersonDetectFail;
      subType = SUB.SecurityModule;
      issueDesc = "Personal detection monitor failure";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("remote emergency stop")) {
      issueType = ISSUE_TYPE.System;
      quick = QUICK.RobotSafetyTriggered;
      subType = SUB.ProgramBug;
      issueDesc = "Remote emergency stop is triggered";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("put incorrectly box on station") || (L.includes("position box") && L.includes("corrected"))) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.LostBoxPos;
      issueDesc = "Some robot put incorrectly box on station.";
      recovery = "Position box was corrected. Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("safety communication failure")) {
      issueType = ISSUE_TYPE.Network;
      quick = QUICK.NetAbn;
      subType = SUB.ProgramBug;
      issueDesc = "Safety communication failure";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("obstacle on the path") && L.includes("dopped box")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.DropBox;
      subType = SUB.ObstacleOnPath;
      issueDesc = "Obstacle on the path dopped box";
      recovery = "Moved out";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("obstacle on the path") && L.includes("dopped item")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.DropBox;
      subType = SUB.ObstacleOnPath;
      issueDesc = "Obstacle on the path dopped item";
      recovery = "Moved out";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("lost box") && L.includes("unknown reason")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.DropBox;
      subType = SUB.ObstacleOnPath;
      issueDesc = "Lost box, unknown reason";
      recovery = "Moved out";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("failed to take a case") && L.includes("unknown reason")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.CannotLocate;
      issueDesc = "Failed to take a case, unknown reason";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("failed to place a case") && L.includes("unknown reason")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.CannotLocate;
      issueDesc = "Failed to place a case, unknown reason";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("moving abnormal")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.CannotLocate;
      issueDesc = "Moving abnormal";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // fallback (still strict options)
    return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
  }

  // ---------------------------
  // Build rows (TSV)
  // Columns order must match your sheet:
  // date | Device Type | Quality(empty) | Device No | Issue Type | Quick Classification | Problem location | Issue Description | Temporary measures | Status | Discoverer | start time | end time | abnormal time
  // ---------------------------
  function buildRows(rec){
    const date = $("date").value.trim();
    const deviceType = $("deviceType").value.trim() || "K50H";
    const quality = ""; // MUST be empty column

    const startTime = extractTime(rec.line);
    const startMin = parseTimeToMinutes(startTime);

    const c = classify(rec.line);

    const status = $("status").value.trim() || "已处理Processed";
    const discoverer = rec.name ? `@${rec.name}` : "@";

    const deviceNos = extractDeviceNos(rec.line);

    return deviceNos.map((deviceNo) => {
      const endTime = startMin==null ? "" : minutesToHHMM(startMin + c.minutes);
      const abnormal = abnormalFmt(c.minutes);

      return [
        date,
        deviceType,
        quality,
        deviceNo,
        c.issueType,
        c.quick,
        c.subType,
        c.issueDesc,
        c.recovery || ($("tempMeasures").value.trim() || "recovery"),
        status,
        discoverer,
        startTime,
        endTime,
        abnormal
      ].join("\t");
    });
  }

  function generate(){
    const recs = splitIntoRecords($("raw").value);
    const outLines = [];
    for(const rec of recs){
      outLines.push(...buildRows(rec));
    }
    $("out").value = outLines.join("\n");
  }

  async function copyTSV(){
    const text = $("out").value;
    if(!text){ alert("Output is empty. Click Generate first."); return; }
    try{
      await navigator.clipboard.writeText(text);
      alert("Copied ✅");
    }catch(e){
      $("out").focus();
      $("out").select();
      alert("Clipboard blocked. Text selected — press Ctrl+C.");
    }
  }

  function downloadTSV(){
    const text = $("out").value || "";
    const blob = new Blob([text], {type:"text/tab-separated-values;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `issue_list_${$("date").value.replaceAll("/","-")}.tsv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function loadExample(){
    $("raw").value = `Ilkin Azimzade
1840. Unable to drive. Missing DM code. Recovery key and set to DM code. 06:44
Mykyta Kyrylov
988. Unable to rotate. Dirty DM code. DM was cleaned, recovery key. 6:53
Rostyslav Mykhavko
209,2145. Collision of 2 robots. Robots collided, while Kiva tried to take a case. Change of position and recovery. 06:53`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("gen").addEventListener("click", generate);
    $("copy").addEventListener("click", copyTSV);
    $("download").addEventListener("click", downloadTSV);
    $("clear").addEventListener("click", () => { $("raw").value=""; $("out").value=""; });
    $("loadExample").addEventListener("click", loadExample);
    console.log("Issue Log Fixer loaded ✅");
  });

})();
</script>
<noscript>
  <div style="padding:12px;color:#ffd37a;">JavaScript is disabled — buttons cannot work.</div>
</noscript>
</body>
</html>