<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Issue Log Fixer → TSV for Feishu</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0c10; color:#eaeaf0; }
    header { padding: 16px 18px; border-bottom: 1px solid #1f2230; background:#0d0f16; position: sticky; top:0; }
    h1 { font-size: 16px; margin: 0 0 6px 0; }
    p { margin: 0; opacity: .8; font-size: 13px; line-height: 1.35; }
    main { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
    .card { border: 1px solid #1f2230; border-radius: 12px; overflow:hidden; background:#0d0f16; }
    .card h2 { font-size: 13px; margin: 0; padding: 10px 12px; border-bottom: 1px solid #1f2230; opacity:.9; }
    .card .body { padding: 12px; }
    textarea { width: 100%; min-height: 280px; background:#0b0c10; color:#eaeaf0; border:1px solid #262a3b; border-radius: 10px; padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size: 12px; line-height: 1.35; }
    input, select { background:#0b0c10; color:#eaeaf0; border:1px solid #262a3b; border-radius: 10px; padding: 8px 10px; font-size: 13px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 1; min-width: 160px; }
    .btns { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { cursor:pointer; border:1px solid #2a2f44; background:#121525; color:#eaeaf0; border-radius: 10px; padding: 8px 10px; font-size: 13px; }
    button.primary { background:#1a2455; border-color:#2e3aa0; }
    button.good { background:#0f2a1c; border-color:#1f6b44; }
    .small { font-size: 12px; opacity:.75; margin-top: 8px; line-height: 1.35; }
    .warn { color:#ffd37a; }
    code { background:#0b0c10; border:1px solid #262a3b; padding: 2px 6px; border-radius: 8px; }
    @media (max-width: 980px){ main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header>
  <h1>Issue Log Fixer → TSV (Feishu-friendly)</h1>
  <p>Paste raw logs → Generate TSV → paste into Feishu. Keeps Device Type → Quality(empty) → Device No.</p>
</header>

<main>
  <section class="card">
    <h2>1) Raw input</h2>
    <div class="body">
      <div class="row" style="margin-bottom:10px;">
        <label>
          <div class="small">Date (YYYY/MM/DD)</div>
          <input id="date" value="2026/02/26" />
        </label>
        <label>
          <div class="small">Default Device Type</div>
          <input id="deviceType" value="K50H" />
        </label>
        <label>
          <div class="small">Default Status</div>
          <input id="status" value="已处理Processed" />
        </label>
        <label>
          <div class="small">Default Temporary measures</div>
          <input id="tempMeasures" value="recovery" />
        </label>
      </div>

      <textarea id="raw" placeholder="Paste raw log here..."></textarea>

      <div class="btns">
        <button class="primary" id="gen" type="button">Generate TSV</button>
        <button id="clear" type="button">Clear</button>
        <button id="loadExample" type="button">Load example</button>
      </div>

      <div class="small warn">
        If you put this HTML into Feishu/Wiki/Docs, scripts are blocked and buttons won’t work.
        You must open it as a local file: <code>file:///...</code>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>2) Output (TSV)</h2>
    <div class="body">
      <div class="row" style="margin-bottom:10px;">
        <label>
          <div class="small">Default minutes if unknown</div>
          <input id="defaultMin" value="2" />
        </label>
      </div>

      <textarea id="out" placeholder="TSV will appear here..."></textarea>

      <div class="btns">
        <button class="good" id="copy" type="button">Copy TSV</button>
        <button id="download" type="button">Download .tsv</button>
      </div>

      <div class="small">Abnormal time format: <code>00:06</code>. End time = Start + minutes.</div>
    </div>
  </section>
</main>

<script>
(function(){
  "use strict";

  const $ = (id) => document.getElementById(id);

  // ---------------------------
  // Allowed dropdown values (MUST MATCH EXACTLY)
  // ---------------------------
  const ISSUE_TYPE = {
    Construction: "施工Construction",
    Equipment: "设备Equipment",
    System: "系统System",
    Environment: "环境Environment",
    Customer: "客户Customer",
    Interface: "接口Interface",
    Operation: "操作Operation",
    Network: "网络Network",
    Unknown: "未知Unknown",
    Design: "设计Design"
  };

  const QUICK = {
    AbnormalPick: "取放货异常Abnormal pick-up and delivery",
    ObstacleAvoid: "避障Obstacle avoidance",
    ForkNoContainer: "货叉检测无容器Forklift detection without container",
    DMCodeError: "识别不到地面码DM Code Error",
    StructuralDamage: "结构件损坏Structural damage",
    UnableDrive: "行走异常Unable to drive",
    NetAbn: "网络通讯异常Network communication abnormality",
    DropBox: "掉箱子或掉落件Drop Box or items",
    BoxStuck: "卡箱异常Box stuck",
    CollisionShelf: "撞货架Collision with Shelf",
    AbnCharging: "充电异常Abnormal charging",
    AbnSound: "设备异响Equipment abnormal sound",
    DataError: "数据错误data error",
    ConveyorScanAbn: "输送线读码器扫码异常",
    RobotSafetyTriggered: "机器人安全装置触发Robot safety device triggered",
    SafetyDoorTriggered: "安全门装置触发Safety door device activated",
    TwoRobotsCollide: "机器人相互碰撞 Two robots collide",
    PersonDetectFail: "人员检测模块故障Personel detection module failure",
    SpeedError: "速度错误Speed Error",
    MotorPwr: "Motor or Powerstage llt error",
    SafetySelfCheck: "安全自检失败safety self check failure",
    NoObjectDetected: "料箱检测无容器No object detected",
    PowerModuleAbn: "电源模块异常Power module is abnormal"
  };

  // Problem location / Issue sub type (问题定位) – must match exactly
  const SUB = {
    GroundDirty: "地面码脏污 Ground code dirty",
    MissingDM: "地面码缺失 Ground code missing",
    Uneven: "地面不平 Uneven ground",
    GroundSeam: "地缝影响 Ground seam effect",
    ForeignObjects: "地面异物Foreign objects on the ground", // IMPORTANT no space
    CannotLocate: "无法定义异常 Problem Cannot located",
    ProgramBug: "程序逻辑BUG Program logic bug",
    LiftingHeight: "举升高度误差Lifting height error",
    WrongPickPlace: "取放箱位置错误 Wrong pick and place box position",
    IrregularOp: "操作不规范 Irregular operation",
    IrregularOperation: "操作不规范 Irregular operation",
    EmergencyStopDamaged: "急停按钮损坏 Emergency stop button is damaged",
    SecurityModuleFail: "安全模块故障Security module failure",
    ParameterConfigErr: "参数配置错误 Parameter configuration error",
    DriverComponentEx: "驱动组件异常 Driver component exception",
    ObstacleOnPath: "路径上有障碍物 Obstacle on the path",
    MainCtrlComm: "主控板通讯异常Main control board communication anomaly",
    AbnormalLifting: "举升机构异常 Abnormal lifting mechanism",
    LostBoxPos: "取放箱位置错误 Wrong pick and place box position",
    CannotLocated: "无法定义异常 Problem Cannot located",
    LiftingHeight: "举升高度误差Lifting height error",
    MaterialSuperHigh: "物料超高 Material super high",
    SecurityModule: "安全模块故障Security module failure",
    ProgramBug: "程序逻辑BUG Program logic bug",
    ChassisCam: "底盘相机故障 Chassis camera malfunction"
  };

  const A42T_E2_SET = new Set([
    163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,
    185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,
    207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,
    229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,
    251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,
    273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,
    295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,
    317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,
    339,340,1301,1302,1303,1304,1305,1306,1307,1308,1309,1310,1311,1312,1313,1314,1315,1316,
    1317,1318,1319,1320,1321,1322,1323,1324,1325,1326,1327,1328,1329,1330,1331,1332,1333,1334,
    1335,1336,1337,1338,1339,1340,1341,1342,1343,1344,1345,1346,1347,1348,1349,1350,1351,1352,
    1353,1354,1355,1356,1357,1358,1359,1360,1361,1362,1363,1364,1365,1366,1367,1368,1369,1370,
    1371,1372,1373,1374,1375,1376,1377,1378,1379,1380,1381,1382,1383,1384,1385,1386,1387,1388,
    1389,1390,1391,1392,1393,1394,1395,1396,1397,1398,1399,1400,1401,1402,1403,1404,1405,1406,
    1407,1408,1409,1410,1411,1412,1413,1414,1415,1416,1417,1418,1419,1420,1421,1422,1423,1424,
    1425,1426,1427,1428,1429,1430,1431,1432,1433,1434,1435,1436,1437,1438,1439,1440,1441,1442,
    1443,1444,1445,1446,1447,1448,1449,1450,1451,1452,1453,1454,1455,1456,1457,1458,1459,1460,
    1461,1462,1463,1464,1465,1466,1467,1468,1469,1470,1471,1472,1473,1474,1475
  ]);

  const K50H_SET = new Set([
    1501,1502,1503,1504,1505,1506,1507,1508,1509,1510,1511,1512,1513,1514,1515,1516,1517,1518,1519,
    1520,1521,1522,1523,1524,1525,1526,1527,1528,1529,1530,1531,1532,1533,1534,1535,1536,1537,1538,
    1539,1540,1541,1542,1543,1544,1545,1546,1547,1548,1549,1550,1551,1552,1553,1554,1555,1556,1557,
    1558,1559,1560,1561,1562,1563,1564,1565,1566,1567,1568,1569,1570,1571,1572,1573,1574,1575,1576,
    1577,1578,1579,1580,1581,1582,1583,1584,1585,1586,1587,1588,1589,1590,1591,1592,1593,1594,1595,
    1596,1597,1598,1599,1600,1601,1602,1603,1604,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,
    1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1625,1626,1627,1628,1629,1630,1631,1632,1633,
    1634,1635,1636,1637,1638,1639,1640,1641,1642,1643,1644,1645,1646,1647,1648,1649,1650,1651,1652,
    1653,1654,1655,1656,1657,1658,1659,1660,1661,1662,1663,1664,1665,1666,1667,1668,1669,1670,1671,
    1672,1673,1674,1675,1676,1677,1678,1679,1680,1681,1682,1683,1684,1685,1686,1687,1688,1689,1690,
    1691,1692,1693,1694,1695,1696,1697,1698,1699,1700,1701,1702,1703,1704,1705,1706,1707,1708,1709,
    1710,1711,1712,1713,1714,1715,1716,1717,1718,1719,1720,1721,1722,1723,1724,1725,1726,1727,1728,
    1729,1730,1731,1732,1733,1734,1735,1736,1737,1738,1739,1740,1741,1742,1743,1744,1745,1746,1747,
    1748,1749,1750,1751,1752,1753,1754,1755,1756,1757,1758,1759,1760,1761,1762,1763,1764,1765,1766,
    1767,1768,1769,1770,1771,1772,1773,1774,1775,1776,1777,1778,1779,1780,1781,1782,1783,1784,1785,
    1786,1787,1788,1789,1790,1791,1792,1793,1794,1795,1796,1797,1798,1799,1800,1801,1802,1803,1804,
    1805,1806,1807,1808,1809,1810,1811,1812,1813,1814,1815,1816,1817,1818,1819,1820,1821,1822,1823,
    1824,1825,1826,1827,1828,1829,1830,1831,1832,1833,1834,1835,1836,1837,1838,1839,1840,1841,1842,
    1843,1844,1845,1846,1847,1848,1849,1850,1851,1852,1853,1854,1855,1856,1857,1858,1859,1860,1861,
    1862,1863,1864,1865,1866,1867,1868,1869,1870,1871,1872,1873,1874,1875,1876,1877,1878,1879,1880,
    1881,1882,1883,1884,1885,1886,1887,1888,1889,1890,1891,1892,1893,1894,1895,1896,1897,1898,1899,
    1900,1901,1902,1903,1904,1905,1906,1907,1908,1909,1910,1911,1912,1913,1914,1915,1916,1917,1918,
    1919,1920,1921,1922,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,
    1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,
    1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,
    1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,
    1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,
    2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024,2025,2026,2027,2028,2029,2030,2031,2032,
    2033,2034,2035,2036,2037,2038,2039,2040,2041,2042,2043,2044,2045,2046,2047,2048,2049,2050,2051,
    2052,2053,2054,2055,2056,2057,2058,2059,2060,2061,2062,2063,2064,2065,2066,2067,2068,2069,2070,
    2071,2072,2073,2074,2075,2076,2077,2078,2079,2080,2081,2082,2083,2084,2085,2086,2087,2088,2089,
    2090,2091,2092,2093,2094,2095,2096,2097,2098,2099,2100,2101,2102,2103,2104,2105,2106,2107,2108,
    2109,2110,2111,2112,2113,2114,2115,2116,2117,2118,2119,2120,2121,2122,2123,2124,2125,2126,2127,
    2128,2129,2130,2131,2132,2133,2134,2135,2136,2137,2138,2139,2140,2141,2142,2143,2144,2145,2146,
    2147,2148,2149,2150,2151,2152,2153,2154,2155,2156,2157,2158,2159,2160,2161,2162,2163,2164,2165,
    2166,2167,2168,2169,2170,2171,2172,2173,2174,2175,2176,2177,2178,2179,2180,2181,2182,2183,2184,
    2185,2186,2187,2188,2189,2190,2191,2192,2193,2194,2195,2196,2197,2198,2199,2200,2201,2202,2203,
    2204,2205,2206,2207,2208,2209,2210,2211,2212,2213,2214,2215,2216,2217,2218,2219,2220,2221,2222,
    2223,2224,2225,2226,2227,2228
  ]);

  function extractDeviceNos(line){
    const s0 = String(line || "").trim();
    if (!s0) return [];

    // Only take the prefix BEFORE the first dot:
    // "209,2145. Collision of 2 robots..." -> "209,2145"
    const prefix = s0.split(".")[0].trim();

    // Now split by comma and clean
    const parts = prefix.split(",").map(x => x.trim()).filter(Boolean);

    // Keep only valid device tokens (robot/station/material patterns)
    // Examples allowed: 209, 2145, H211/1111, 1111/H111, CS256/1132, PPPO123...
    const valid = [];
    for (const p of parts){
      const U = p.toUpperCase();
      if (
        /^PPPO\d+/.test(U) ||
        /^CS\d+(?:\/\d+)?$/.test(U) ||
        /^H\d+(?:\/\d+)?$/.test(U) ||
        /^\d+(?:\/H\d+)?$/.test(U) ||
        /^\d+$/.test(U)
      ){
        valid.push(p);
      }
    }

    // Deduplicate
    const seen = new Set();
    const out = [];
    for (const t of valid){
      const key = t.toUpperCase();
      if (!seen.has(key)){
        seen.add(key);
        out.push(t);
      }
    }
    return out;
  }

  function inferStationFromH(Htoken){
    const U = String(Htoken || "").toUpperCase();
    // H1xx => Work Station, H2xx => Tally station
    if (/^H2\d+/.test(U)) return "Tally station";
    return "Work Station";
  }

  function normalizeDeviceToken(token){
    const raw0 = String(token || "").trim();
    if (!raw0) return { raw: "", left: "", num: NaN, prefix: "", hasSlash: false };

    // strip punctuation around full token
    const raw = raw0.replace(/^[^\w]+|[^\w]+$/g, "");
    const U = raw.toUpperCase();

    const hasSlash = U.includes("/");
    const left = hasSlash ? U.split("/")[0].trim() : U;

    let prefix = "NUM";
    if (left.startsWith("PPPO")) prefix = "PPPO";
    else if (left.startsWith("CS")) prefix = "CS";
    else if (left.startsWith("H")) prefix = "H";

    const m = left.match(/\d+/);
    const num = m ? Number(m[0]) : NaN;

    return { raw, U, left, num, prefix, hasSlash };
  }

  function inferDeviceTypeFromNo(token, fallback){
    const fb = (fallback && fallback.trim()) ? fallback.trim() : "K50H";
    const t = normalizeDeviceToken(token);
    if (!t.raw) return fb;

    // LEFT-side rule:
    // 1111/H111 -> robot
    // H111/1111 -> station
    if (t.prefix === "PPPO") return "Material box";
    if (t.prefix === "CS") return "Charging station";
    if (t.prefix === "H")  return inferStationFromH(t.left);

    // robot set mapping
    if (!Number.isFinite(t.num)) return fb;
    if (K50H_SET.has(t.num)) return "K50H";
    if (A42T_E2_SET.has(t.num)) return "A42T-E2 hook";

    return fb;
  }

  // Device No column (THIS is where we keep H111/1111)
  function normalizeDeviceNoForColumn(token){
    const t = normalizeDeviceToken(token);
    if (!t.raw) return "";

    // keep full token for these cases
    if (t.prefix === "PPPO") return t.raw;      // PPPO...
    if (t.prefix === "CS") return t.raw;        // CS256/1132 (keep as text)
    if (t.prefix === "H") return t.raw;         // H111/1111 MUST stay as H111/1111

    // robot cases: "764/H136" => 764, "1111/H111" => 1111, "1866." => 1866
    return Number.isFinite(t.num) ? t.num : "";
  }

  


  // ---------------------------
  // Helpers
  // ---------------------------
  function pad2(n){ return String(n).padStart(2,"0"); }
  function parseTimeToMinutes(t){
    const m = String(t).trim().match(/^(\d{1,2})\s*:\s*(\d{2})$/);
    if(!m) return null;
    const hh = +m[1], mm = +m[2];
    if(hh>23 || mm>59) return null;
    return hh*60 + mm;
  }
  function minutesToHHMM(total){
    total = ((total % 1440) + 1440) % 1440;
    return `${Math.floor(total/60)}:${pad2(total%60)}`;
  }
  function abnormalFmt(mins){ return `00:${pad2(Math.max(0, Math.round(mins)))}`; }

  function normText(s){
    return String(s)
      .replace(/\s+/g," ")
      .replace(/[，]/g,",")
      .trim();
  }
  function low(s){ return normText(s).toLowerCase(); }

  function extractTime(line){
    const m = line.match(/(\d{1,2}\s*:\s*\d{2})(?!.*\d{1,2}\s*:\s*\d{2})/);
    return m ? m[1].replace(/\s+/g,"") : "";
  }

  // Split input into records with names
  function splitIntoRecords(raw){
    const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    let name = "";
    const recs = [];
    for(const line of lines){
      const isName = !/[0-9]/.test(line) && !/\./.test(line) && line.length <= 60;
      if(isName){ name = line; continue; }
      recs.push({name, line});
    }
    return recs;
  }

  // ---------------------------
  // RULE ENGINE (STRICT OPTIONS ONLY)
  // ---------------------------
  function classify(line){
    // user rule: no "Unable to rotate" option -> treat as Unable to drive
    let txt = normText(line)
      .replace(/unable to rotate/ig, "Unable to drive")
      .replace(/dirty dm code/ig, "Dirty DM code")
      .replace(/lost dm code/ig, "Missing DM code"); // treat as missing dm for dropdown consistency

    const L = low(txt);

    // default for Unable to drive = Equipment (you asked)
    let issueType = ISSUE_TYPE.Equipment;
    let quick = QUICK.UnableDrive;
    let subType = SUB.CannotLocate;
    let issueDesc = txt.replace(/^\s*[^.]+\.\s*/,"").replace(/\s*\d{1,2}:\d{2}\s*$/,"").trim();
    let recovery = "Recovery";
    let minutes = Number($("defaultMin").value) || 2;

    // ---- DM cases ----
    if(L.includes("dirty dm code") || L.includes("ground code dirty")){
      issueType = ISSUE_TYPE.Environment;               // YOU SPECIFIED this
      quick = QUICK.UnableDrive;
      subType = SUB.GroundDirty;
      issueDesc = "Unable to drive. Dirty DM code.";
      recovery = "DM was cleaned, recovery key";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if(L.includes("missing dm code")){
      issueType = ISSUE_TYPE.Equipment;                 // YOU SPECIFIED this
      quick = QUICK.UnableDrive;
      subType = SUB.ChassisCam;                         // you asked chassis cam for missing dm
      issueDesc = "Unable to drive. Missing DM code.";
      recovery = "Recovery key and set to DM code";
      minutes = 3;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // If phrase says "could not find dm code on the floor"
    if(L.includes("could not find dm code") || L.includes("cannot find dm code")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.ChassisCam; // floor code missing
      issueDesc = "Could not find DM code on the floor.";
      recovery = "Recovery";
      minutes = 3;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- uneven / seam ----
    if(L.includes("uneven ground")){
      issueType = ISSUE_TYPE.Environment;                 // you said mostly Equipment
      quick = QUICK.UnableDrive;
      subType = SUB.Uneven;
      issueDesc = "Unable to drive. Uneven ground.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if(L.includes("ground seam")){
      issueType = ISSUE_TYPE.Environment;
      quick = QUICK.UnableDrive;
      subType = SUB.GroundSeam;
      issueDesc = "Unable to drive. Ground seam effect.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("lifting mechanism failure")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.LiftingHeight;
      issueDesc = "Lifting mechanism failure.";
      recovery = "Recovery";
      minutes = 2;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // ---- foreign object on floor ----
    if(L.includes("foreign object on the floor") || L.includes("foreign objects on the floor") || L.includes("foreign object")){
      issueType = ISSUE_TYPE.Customer;
      quick = QUICK.UnableDrive;                        // forced due to your dropdown limitation
      subType = SUB.ForeignObjects;                     // MUST be exact no-space version
      issueDesc = "Unable to drive. Foreign object on the floor.";
      recovery = "DM was cleaned, recovery key";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- obstacle detection in tally station ----
    if(L.includes("obstacle detection in tally station")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.ObstacleAvoid;
      subType = SUB.CannotLocate;
      issueDesc = "Obstacle detection in tally station";
      recovery = "Recovery";
      minutes = 4;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("lost his track in tally station")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.CannotLocated;
      issueDesc = "Lost his track in tally station";
      recovery = "Recovery";
      minutes = 2;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // ---- lost track / no sound ----
    if(L.includes("lost his track") || L.includes("no sound")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.CannotLocate;
      issueDesc = "Lost his track, no sound.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if(L.includes("system error")){
      issueType = ISSUE_TYPE.System;
      quick = QUICK.UnableDrive;
      subType = SUB.ProgramBug;
      issueDesc = "System error, unknown";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- collision of 2 robots ----
    if(L.includes("collision of 2 robots") || L.includes("robots collided") || L.includes("robot collision")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.TwoRobotsCollide;
      subType = SUB.CannotLocate;
      issueDesc = "Collision of 2 robots. Robots collided.";
      recovery = "Change of position and recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("collision of 2 robots") && L.includes("kiva") && L.includes("take a case")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.TwoRobotsCollide;
      subType = SUB.LostBoxPos;
      issueDesc = "Robots collided, while Kiva tired to take a case";
      recovery = "Change of position and recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("collision of 2 robots") && L.includes("kubot") && L.includes("take a case")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.TwoRobotsCollide;
      subType = SUB.LostBoxPos;
      issueDesc = "Robots collided, while Kubot tired to take a case";
      recovery = "Change of position and recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if ((L.includes("failed to take the box") || L.includes("failed to take the case")) && L.includes("hit the workstation")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.CollisionShelf;
      subType = SUB.LostBoxPos;
      issueDesc = "Failed to take the box, hit the workstation";
      recovery = "Change of position and recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // ---- no object after detection picking on lifting tray ----
    if(L.includes("no object after detection")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.NoObjectDetected;
      subType = SUB.LiftingHeight;
      issueDesc = "No object after detection picking on lifting tray (conveyor).";
      recovery = "Case was put on a robot, recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("abnormal box delivery") || (L.includes("failed to place") && L.includes("dropped"))) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.LostBoxPos;
      issueDesc = "Abnormal box delivery. Failed to place a case, dropped case.";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("failed to delivered a case") && L.includes("irregular operation") && L.includes("tally")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.IrregularOperation; // make sure SUB.IrregularOperation exists in your SUB list
      issueDesc = "Failed to delivered a case, irregular operation on tally station.";
      recovery = "Box moved out";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("failed to place a case") && (L.includes("material box too high") || L.includes("too high"))) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.MaterialSuperHigh;
      issueDesc = "Failed to place a case, material box too high";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("external retrieval abnormal")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.AbnormalLifting;
      issueDesc = "External retrieval abnormal.";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // ---- safety vest detection speed monitor failure ----
    if(L.includes("safety vest detection speed") || (L.includes("vest") && L.includes("key"))){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.SpeedError;
      subType = SUB.ProgramBug;
      issueDesc = "Safety vest detection speed monitor failure.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- all protection triggers released / abnormal lifting mechanism ----
    if (L.includes("all protection triggers") || (L.includes("abnormal lifting") && L.includes("mechanism"))){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.RobotSafetyTriggered;
      subType = SUB.AbnormalLifting;   // <-- we must add this key below
      issueDesc = "All protection triggers has been released. Abnormal lifting mechanisms.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- emergency stop ----
    if(L.includes("emergency stop")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.RobotSafetyTriggered;
      subType = SUB.EmergencyStopDamaged;
      issueDesc = "Emergency stop triggered. Emergency stop button damaged.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- safety self check ----
    if(L.includes("safety self check failure")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.SafetySelfCheck;
      subType = SUB.SecurityModuleFail;
      issueDesc = "Safety self check failure. Security module failure.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- charging failure ----
    if(L.includes("charging failure")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnCharging;
      subType = SUB.ParameterConfigErr;
      issueDesc = "Charging failure. Parameter configuration error.";
      recovery = L.includes("dynamic") ? "Changed mode to Dynamic" : "Changed mode to Auto";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- speed error / drive component exception ----
    if(L.includes("speed error") || L.includes("drive component exception")){
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.SpeedError;
      subType = SUB.DriverComponentEx;
      issueDesc = "Speed error. Drive component exception.";
      recovery = "Recovery";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    // ---- customer fault example: box already on position ----
    if(L.includes("customer fault") || L.includes("box already on the position") || L.includes("box already on position")){
      issueType = ISSUE_TYPE.Customer;
      quick = QUICK.AbnormalPick;
      subType = SUB.IrregularOp;
      issueDesc = "Failed to take the box. Box already on position. Customer fault.";
      recovery = "Put box back";
      minutes = 2;
      return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
    }

    if (L.includes("battery communication failure")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.PowerModuleAbn;
      subType = SUB.CannotLocated;
      issueDesc = "Battery communication failure. Unknown reason.";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("fail to take a case") && L.includes("wrong box position")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.LostBoxPos;
      issueDesc = "Wrong box position";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("kiva failed to place a case") && L.includes("tote misaligned")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.BoxStuck;
      subType = SUB.LostBoxPos;
      issueDesc = "Kiva failed to place a case, tote misaligned during transfer, left hanging diagonally in rack";
      recovery = "Recovery";
      minutes = 5;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("personal detection monitor failure") || (L.includes("security module failure") && L.includes("personal"))) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.PersonDetectFail;
      subType = SUB.SecurityModule;
      issueDesc = "Personal detection monitor failure";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("remote emergency stop")) {
      issueType = ISSUE_TYPE.System;
      quick = QUICK.RobotSafetyTriggered;
      subType = SUB.ProgramBug;
      issueDesc = "Remote emergency stop is triggered";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("put incorrectly box on station") || (L.includes("position box") && L.includes("corrected"))) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.LostBoxPos;
      issueDesc = "Some robot put incorrectly box on station.";
      recovery = "Position box was corrected. Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("safety communication failure")) {
      issueType = ISSUE_TYPE.Network;
      quick = QUICK.NetAbn;
      subType = SUB.ProgramBug;
      issueDesc = "Safety communication failure";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("obstacle on the path") && L.includes("dopped box")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.DropBox;
      subType = SUB.ObstacleOnPath;
      issueDesc = "Obstacle on the path dopped box";
      recovery = "Moved out";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("obstacle on the path") && L.includes("dopped item")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.DropBox;
      subType = SUB.ObstacleOnPath;
      issueDesc = "Obstacle on the path dopped item";
      recovery = "Moved out";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("lost box") && L.includes("unknown reason")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.DropBox;
      subType = SUB.CannotLocate;
      issueDesc = "Lost box, unknown reason";
      recovery = "Moved out";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("failed to take a case") && L.includes("unknown reason")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.CannotLocate;
      issueDesc = "Failed to take a case, unknown reason";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("failed to place a case") && L.includes("unknown reason")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.AbnormalPick;
      subType = SUB.CannotLocate;
      issueDesc = "Failed to place a case, unknown reason";
      recovery = "Recovery";
      minutes = 4;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    if (L.includes("moving abnormal")) {
      issueType = ISSUE_TYPE.Equipment;
      quick = QUICK.UnableDrive;
      subType = SUB.CannotLocate;
      issueDesc = "Moving abnormal";
      recovery = "Recovery";
      minutes = 3;
      return { issueType, quick, subType, issueDesc, recovery, minutes, txt };
    }

    // fallback (still strict options)
    return {issueType, quick, subType, issueDesc, recovery, minutes, txt};
  }

  // ---------------------------
  // Build rows (TSV)
  // Columns order must match your sheet:
  // date | Device Type | Quality(empty) | Device No | Issue Type | Quick Classification | Problem location | Issue Description | Temporary measures | Status | Discoverer | start time | end time | abnormal time
  // ---------------------------
  function buildRows(rec){
    const date = $("date").value.trim();
    const fallbackDeviceType = $("deviceType").value.trim() || "K50H";
    const quality = ""; // MUST be empty column

    const startTime = extractTime(rec.line);
    const startMin = parseTimeToMinutes(startTime);

    const c = classify(rec.line);

    const status = $("status").value.trim() || "已处理Processed";
    const discoverer = rec.name ? `@${rec.name}` : "@";

    const deviceNosRaw = extractDeviceNos(rec.line);

    // if no device numbers found, still output ONE row (optional)
    if (!deviceNosRaw.length){
      const deviceType = fallbackDeviceType;
      const endTime = startMin==null ? "" : minutesToHHMM(startMin + c.minutes);
      const abnormal = abnormalFmt(c.minutes);

      return [[
        date, deviceType, quality, "",
        c.issueType, c.quick, c.subType, c.issueDesc,
        c.recovery || ($("tempMeasures").value.trim() || "recovery"),
        status, discoverer, startTime, endTime, abnormal
      ].join("\t")];
    }

    return deviceNosRaw.map((raw) => {
      const deviceNo = normalizeDeviceNoForColumn(raw);
      const deviceType = inferDeviceTypeFromNo(raw, fallbackDeviceType);

      const endTime = startMin==null ? "" : minutesToHHMM(startMin + c.minutes);
      const abnormal = abnormalFmt(c.minutes);

      return [
        date,
        deviceType,
        quality,
        deviceNo,
        c.issueType,
        c.quick,
        c.subType,
        c.issueDesc,
        c.recovery || ($("tempMeasures").value.trim() || "recovery"),
        status,
        discoverer,
        startTime,
        endTime,
        abnormal
      ].join("\t");
    });
  }

  function normalizeDeviceToken(token){
    const raw = String(token || "").trim();
    if (!raw) return { raw: "", left: "", num: NaN, prefix: "" };

    // IMPORTANT: device type is based on LEFT side of "/" as you requested:
    // 1111/H111 -> LEFT=1111 => robot
    // H111/1111 -> LEFT=H111 => station
    const leftRaw = raw.includes("/") ? raw.split("/")[0].trim() : raw;

    // strip punctuation around token (".", ",", ":" etc)
    const left = leftRaw.replace(/^[^\w]+|[^\w]+$/g, "").toUpperCase();

    // detect prefix
    let prefix = "";
    if (left.startsWith("PPPO")) prefix = "PPPO";
    else if (left.startsWith("CS")) prefix = "CS";
    else if (left.startsWith("H")) prefix = "H";
    else prefix = "NUM";

    // first number inside token
    const m = left.match(/\d+/);
    const num = m ? Number(m[0]) : NaN;

    return { raw, left, num, prefix };
  }

  function inferDeviceTypeFromNo(deviceNoRaw, fallback){
    const fb = (fallback && fallback.trim()) ? fallback.trim() : "K50H";
    const t = normalizeDeviceToken(deviceNoRaw);

    // Station / special tokens (based on LEFT side)
    if (t.prefix === "PPPO") return "Material box";
    if (t.prefix === "CS") return "Charging station";

    // H1.. => Work Station, H2.. => Tally station
    if (t.prefix === "H") {
      if (/^H1\d+/.test(t.left)) return "Work Station";
      if (/^H2\d+/.test(t.left)) return "Tally station";
      return "Work Station"; // fallback for other Hxxx if you want
    }

    // Robots: use numeric mapping sets
    if (!Number.isFinite(t.num)) return fb;
    if (K50H_SET.has(t.num)) return "K50H";
    if (A42T_E2_SET.has(t.num)) return "A42T-E2 hook";

    return fb;
  }

  // If you still need the "deviceNo" value for column 4:
  function normalizeDeviceNoForColumn(token){
    const t = normalizeDeviceToken(token);

    // keep PPPO as text in the device number column (or return empty if you prefer)
    if (t.prefix === "PPPO") return t.left;

    // for CS256/1132, 764/H136, H174 => first number
    return Number.isFinite(t.num) ? t.num : "";
  }

  function inferStationFromH(Htoken){
    const U = String(Htoken || "").toUpperCase().trim();

    // H2.. => Tally station
    if (/^H2/.test(U)) return "Tally station";

    // H1.. => Work Station
    if (/^H1/.test(U)) return "Work Station";

    // other Hxxx default
    return "Work Station";
  }

  function generate(){
    const recs = splitIntoRecords($("raw").value);
    const outLines = [];
    for(const rec of recs){
      outLines.push(...buildRows(rec));
    }
    $("out").value = outLines.join("\n");
  }

  async function copyTSV(){
    const text = $("out").value;
    if(!text){ alert("Output is empty. Click Generate first."); return; }
    try{
      await navigator.clipboard.writeText(text);
      alert("Copied ✅");
    }catch(e){
      $("out").focus();
      $("out").select();
      alert("Clipboard blocked. Text selected — press Ctrl+C.");
    }
  }

  function downloadTSV(){
    const text = $("out").value || "";
    const blob = new Blob([text], {type:"text/tab-separated-values;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `issue_list_${$("date").value.replaceAll("/","-")}.tsv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function loadExample(){
    $("raw").value = `Ilkin Azimzade
1840. Unable to drive. Missing DM code. Recovery key and set to DM code. 06:44
Mykyta Kyrylov
988. Unable to rotate. Dirty DM code. DM was cleaned, recovery key. 6:53
Rostyslav Mykhavko
209,2145. Collision of 2 robots. Robots collided, while Kiva tried to take a case. Change of position and recovery. 06:53`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("gen").addEventListener("click", generate);
    $("copy").addEventListener("click", copyTSV);
    $("download").addEventListener("click", downloadTSV);
    $("clear").addEventListener("click", () => { $("raw").value=""; $("out").value=""; });
    $("loadExample").addEventListener("click", loadExample);
    console.log("Issue Log Fixer loaded ✅");
  });

})();
</script>
<noscript>
  <div style="padding:12px;color:#ffd37a;">JavaScript is disabled — buttons cannot work.</div>
</noscript>
<div style="
  position:fixed;
  bottom:8px;
  left:50%;
  transform:translateX(-50%);
  font-size:10px;
  opacity:0.35;
  letter-spacing:1px;
  z-index:999;
">
  <a href="https://lknzmzd.xyz"
     target="_blank"
     style="
       text-decoration:none;
       color:#8fa2ff;
     "
     onmouseover="this.style.opacity='1'"
     onmouseout="this.style.opacity='0.35'"
  >
    © LKNZMZD
  </a>
</div>
</body>
</html>